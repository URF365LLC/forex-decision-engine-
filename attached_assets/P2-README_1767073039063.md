# P2 Code Quality Tasks - Implementation Patches

## Overview

This folder contains **7 P2 Code Quality patches** for improved maintainability and robustness.

| Task | File | Issue | Complexity |
|------|------|-------|------------|
| **#7** | `P2-TASK-7-fixHardcodedTimeframes.patch.ts` | Hardcoded H4/H1 timeframes | Low |
| **#8** | `P2-TASK-8-replaceConsoleWarn.patch.ts` | console.warn instead of logger | Low |
| **#9** | `P2-TASK-9-replaceSubstr.patch.ts` | Deprecated substr() | Low |
| **#10** | `P2-TASK-10-extractPositionSizing.patch.ts` | Duplicate position sizing | Medium |
| **#11** | `P2-TASK-11-frontendCacheExpiry.patch.ts` | No frontend cache TTL | Medium |
| **#12** | `P2-TASK-12-journalValidation.patch.ts` | Missing journal validation | Medium |
| **#13** | `P2-TASK-13-strategyAwareScanLock.patch.ts` | Global scan lock | Medium |

---

## Implementation Order (Suggested)

```
#9 → #8 → #7 → #10 → #11 → #12 → #13
```

**Reasoning:**
1. **#9** - Quick 1-line fix
2. **#8** - Quick find/replace
3. **#7** - Simple addition
4. **#10** - Refactor, may affect other files
5. **#11** - Frontend only, isolated
6. **#12** - Backend only, isolated
7. **#13** - Most complex, test thoroughly

---

## Quick Reference

### Task #7: Hardcoded Timeframes
**File:** `src/strategies/utils.ts` line 80  
**Fix:** Use `registry.meta.timeframes` instead of hardcoded H4/H1

```typescript
// BEFORE
return { trend: 'H4', entry: 'H1' };

// AFTER
if (meta.timeframes) {
  return { trend: meta.timeframes.trend, entry: meta.timeframes.entry };
}
return STYLE_TIMEFRAMES[style];
```

---

### Task #8: Console.warn
**File:** `src/strategies/utils.ts` lines 17, 24  
**Fix:** Replace with structured logger

```typescript
// BEFORE
console.warn(`Invalid ATR value for ${symbol}: ${atr}`);

// AFTER
logger.warn('Invalid ATR value', { symbol, atr });
```

---

### Task #9: Deprecated substr()
**File:** `src/storage/journalStore.ts` line 144  
**Fix:** Use substring() or slice()

```typescript
// BEFORE
Math.random().toString(36).substr(2, 9)

// AFTER
Math.random().toString(36).substring(2, 11)
```

---

### Task #10: Position Sizing
**File:** `src/strategies/utils.ts` lines 126-133  
**Fix:** Extract to shared function, update all callers

```typescript
// NEW FUNCTION
export function calculatePositionSize(input: PositionSizeInput): PositionSizeResult

// USAGE
const position = calculatePositionSize({
  symbol, entryPrice, stopLossPrice, accountSize, riskPercent
});
```

---

### Task #11: Frontend Cache
**File:** `public/js/storage.js`  
**Fix:** Add 15-minute expiry check

```javascript
// BEFORE
getResults() {
  return JSON.parse(localStorage.getItem('scanResults'));
}

// AFTER
getResults() {
  const data = JSON.parse(localStorage.getItem('scanResults'));
  const age = Date.now() - new Date(data.timestamp).getTime();
  if (age > 15 * 60 * 1000) return null; // Expired
  return data;
}
```

---

### Task #12: Journal Validation
**File:** `src/server.ts` PUT `/api/journal/:id`  
**Fix:** Add input validation before save

```typescript
// ADD VALIDATION
const errors = validateJournalEntry(req.body);
if (errors.length > 0) {
  return res.status(400).json({ errors });
}
```

---

### Task #13: Strategy-Aware Lock
**File:** `src/engine/strategyAnalyzer.ts` line 41  
**Fix:** Key lock by strategyId

```typescript
// BEFORE
let scanInProgress = false;

// AFTER
const activeScans: Map<string, ScanInfo> = new Map();

function acquireScanLock(strategyId: string): boolean {
  if (activeScans.has(strategyId)) return false;
  activeScans.set(strategyId, { startedAt: Date.now() });
  return true;
}
```

---

## Testing Checklist

### After Each Task

- [ ] `npm run build` compiles without errors
- [ ] `npm run test` passes (if tests exist)
- [ ] Manual smoke test of affected feature

### Task-Specific Tests

**#7 Timeframes:**
- [ ] Strategy with custom timeframes uses them
- [ ] Default style timeframes work for others

**#8 Logger:**
- [ ] Warnings appear in log file, not just console
- [ ] Log format includes timestamp and context

**#9 substr:**
- [ ] Generated IDs are still 9 chars after the dash
- [ ] No deprecation warnings in console

**#10 Position Sizing:**
- [ ] Test with EURUSD (4-decimal)
- [ ] Test with USDJPY (2-decimal)
- [ ] Test edge cases (tiny stop, huge position)

**#11 Frontend Cache:**
- [ ] Fresh results shown after 15 min
- [ ] Cache status indicator updates
- [ ] Page refresh shows correct state

**#12 Journal:**
- [ ] Invalid entry returns 400 with errors
- [ ] Valid entry saves successfully
- [ ] XSS in notes field is sanitized

**#13 Scan Lock:**
- [ ] Different strategies can scan simultaneously
- [ ] Same strategy blocks second scan
- [ ] Force flag cancels previous scan

---

## Estimated Time

| Task | Time |
|------|------|
| #7 | 10 min |
| #8 | 10 min |
| #9 | 5 min |
| #10 | 30 min |
| #11 | 20 min |
| #12 | 30 min |
| #13 | 45 min |
| **Total** | **~2.5 hours** |

---

## Files Summary

All patches include:
- Problem description
- Current vs fixed code
- Complete replacement functions
- Migration guide
- Testing suggestions

Download all files and implement in order for best results.
