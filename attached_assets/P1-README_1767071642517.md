# P1 High Priority Tasks - Implementation Patches

## Overview

This folder contains **2 P1 High Priority patches** for risk management and user experience.

| Task | File | Issue | Impact |
|------|------|-------|--------|
| **#4** | `P1-TASK-4-safetyGates.patch.ts` | Safety gates bypassed | Risk management compromised |
| **#6** | `P1-TASK-6-gradeUpgradeDetection.patch.ts` | No upgrade alerts | Users miss improving setups |

---

## Implementation Order

```
Task #4 → Task #6
```

**Why this order?**
1. Task #4 adds gating infrastructure that Task #6 respects
2. Task #6 only tracks non-blocked signals (depends on gating info)

---

## Task #4: Safety Gates Integration

### Problem
The multi-strategy `strategyAnalyzer.ts` bypasses `signalCooldown` and `volatilityGate` that exist in `decisionEngine.ts`. This means:
- Duplicate signals can fire repeatedly
- Extreme volatility doesn't block entries
- Risk management is compromised

### Files to Modify

1. **`src/engine/strategyAnalyzer.ts`** - Main changes

### Key Changes

```typescript
// 1. Add imports
import { signalCooldown } from '../services/signalCooldown.js';
import { checkVolatility } from '../services/volatilityGate.js';

// 2. Add to analyzeSymbolWithStrategy() AFTER strategy.analyze():

// Volatility check
const volatilityCheck = checkVolatility(symbol, currentAtr, atrHistory);

// Cooldown check
const cooldownCheck = signalCooldown.check(symbol, style, direction, grade);

// Apply gating
if (!volatilityCheck.allowed) {
  finalStatus = 'volatility-blocked';
  finalDirection = 'none';
}
else if (!cooldownCheck.allowed) {
  finalStatus = 'cooldown';
}

// 3. Add gating field to decision
decision.gating = {
  cooldownBlocked: !cooldownCheck.allowed,
  volatilityBlocked: !volatilityCheck.allowed,
  volatilityLevel: volatilityCheck.level,
};

// 4. Record signal (only if not blocked)
if (!blocked) {
  signalCooldown.record(symbol, style, direction, grade, validUntil);
}
```

### Gate Priority

```
Volatility Gate (safety) → Cooldown (spam prevention) → Signal
```

- Volatility cannot be skipped (safety critical)
- Cooldown can be skipped with `options.skipCooldown = true` (manual refresh)

---

## Task #6: Grade Upgrade Detection

### Problem
When a symbol improves from B → A+ or no-trade → trade, users aren't notified. They might miss emerging high-quality setups.

### Files to Create/Modify

1. **`src/services/gradeTracker.ts`** - NEW FILE
2. **`src/engine/strategyAnalyzer.ts`** - Add tracking calls
3. **`src/server.ts`** - Add SSE endpoint
4. **`public/js/app.js`** - Add notification UI
5. **`public/styles.css`** - Add notification styles
6. **`public/index.html`** - Add notification container

### New Service: GradeTracker

```typescript
// src/services/gradeTracker.ts
export const gradeTracker = {
  // Track grades by symbol/strategy
  updateGrade(symbol, strategyId, strategyName, grade, direction): GradeUpgrade | null,
  
  // Get previous grade
  getPreviousGrade(symbol, strategyId): GradeRecord | null,
  
  // Event handling
  onUpgrade(handler): void,
  offUpgrade(handler): void,
  
  // Recent upgrades for page load
  getRecentUpgrades(sinceMinutes): GradeUpgrade[],
};
```

### Upgrade Types

| Type | Trigger | Example |
|------|---------|---------|
| `new-signal` | no-trade → trade | EURUSD was quiet, now has B LONG |
| `grade-improvement` | B → A+ | EURUSD improved from B to A+ |
| `new-signal` | Direction flip | EURUSD was LONG, now SHORT |

### SSE Endpoint

```typescript
// GET /api/upgrades/stream - Real-time SSE
// GET /api/upgrades/recent?minutes=60 - Recent upgrades
```

### Frontend Integration

```javascript
// Connect to SSE
const eventSource = new EventSource('/api/upgrades/stream');
eventSource.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'upgrade') {
    showNotification(data.upgrade);
  }
};
```

---

## Testing Checklist

### After Task #4
- [ ] Signal on EURUSD, then scan again → Should show "cooldown" status
- [ ] High ATR symbol → Should show "volatility-blocked"
- [ ] Force refresh → Should bypass cooldown
- [ ] Logs show `[COOLDOWN]` and `[VOL-BLOCKED]` tags

### After Task #6
- [ ] Scan with no-trade symbol → no notification
- [ ] Symbol improves to B → "New signal" notification appears
- [ ] Symbol improves B → A+ → "Upgrade" notification appears
- [ ] Page reload → Recent upgrades show in notification area
- [ ] SSE connection stays alive (check Network tab)

---

## Quick Copy-Paste Snippets

### Add to StrategyDecision interface:

```typescript
gating: {
  cooldownBlocked: boolean;
  cooldownReason?: string;
  cooldownUntil?: string;
  volatilityBlocked: boolean;
  volatilityLevel: 'low' | 'normal' | 'high' | 'extreme';
  volatilityReason?: string;
};

upgrade?: {
  symbol: string;
  strategyId: string;
  strategyName: string;
  previousGrade: 'A+' | 'B' | 'no-trade';
  newGrade: 'A+' | 'B';
  direction: 'long' | 'short';
  upgradeType: 'new-signal' | 'grade-improvement';
  timestamp: string;
  message: string;
};
```

### HTML notification container:

```html
<!-- Add after <body> -->
<div id="upgrade-notifications"></div>
```

### CSS for notifications:

```css
#upgrade-notifications {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
  max-width: 350px;
}

.upgrade-notification {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 16px;
  background: var(--surface);
  border-radius: 8px;
  border-left: 4px solid var(--accent-green);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  animation: slideIn 0.3s ease-out;
}
```

---

## Estimated Implementation Time

| Task | Time | Complexity |
|------|------|------------|
| #4 Safety Gates | 30-45 min | Medium |
| #6 Grade Upgrades | 60-90 min | Medium-High |
| **Total** | **1.5-2.5 hours** | |

---

## Dependencies

### Task #4 requires:
- `src/services/signalCooldown.ts` (should exist)
- `src/services/volatilityGate.ts` (should exist)

### Task #6 requires:
- Task #4 completed (uses gating info)
- EventEmitter from Node.js (built-in)
