UPDATE rsiBounce.ts - VALIDATED FIX (Minimal Changes, No Strategy Mutation)

This fix was validated by Claude and ChatGPT. It fixes bugs WITHOUT changing 
the strategy's core mean-reversion logic.

═══════════════════════════════════════════════════════════════════════════════
CHANGES SUMMARY:
═══════════════════════════════════════════════════════════════════════════════

1. ADD timeframes to meta (line 12)
2. FIX type cast for validateIndicators (line 24)
3. FIX NaN-safe indicator gating (lines 35-41)
4. ADD missing reason codes for candle confirmation (lines 58, 76)
5. FIX unreachable RR boost threshold (line 93: 1.5 → 1.25)
6. UPDATE version string (line 17)

═══════════════════════════════════════════════════════════════════════════════
REPLACE rsiBounce.ts WITH:
═══════════════════════════════════════════════════════════════════════════════

import { IStrategy, StrategyMeta, Decision, IndicatorData, UserSettings, ReasonCode } from '../types.js';
import { atIndex, validateOrder, validateIndicators, buildDecision, clamp } from '../utils.js';

export class RsiBounce implements IStrategy {
  meta: StrategyMeta = {
    id: 'rsi-bounce',
    name: 'RSI Oversold Bounce',
    description: 'Mean reversion from RSI extremes with Bollinger Band confirmation',
    style: 'intraday',
    timeframes: { trend: 'H4', entry: 'H1' },  // ✅ FIX 1: Added
    winRate: 72,
    avgRR: 1.2,
    signalsPerWeek: '15-25',
    requiredIndicators: ['bars', 'rsi', 'bbands', 'atr', 'sma20'],
    version: '2026-01-01',  // ✅ Updated
  };

  async analyze(data: IndicatorData, settings: UserSettings): Promise<Decision | null> {
    const { symbol, bars, rsi, bbands, atr, sma20 } = data;

    if (!bars || bars.length < 50) return null;

    // ✅ FIX 2: Correct TS-safe cast pattern
    if (!validateIndicators(data as unknown as Record<string, unknown>, this.meta.requiredIndicators, 50)) return null;

    const entryIdx = bars.length - 1;
    const signalIdx = bars.length - 2;

    const entryBar = bars[entryIdx];
    const signalBar = bars[signalIdx];

    const rsiSignal = atIndex(rsi, signalIdx);
    const bbSignal = atIndex(bbands, signalIdx);
    const atrSignal = atIndex(atr, signalIdx);
    const smaSignal = atIndex(sma20, signalIdx);

    // ✅ FIX 3: NaN-safe gating (don't use falsy checks on numbers)
    if (
      !Number.isFinite(rsiSignal) ||
      !bbSignal ||
      !Number.isFinite(atrSignal) ||
      !Number.isFinite(smaSignal)
    ) {
      return null;
    }

    const triggers: string[] = [];
    const reasonCodes: ReasonCode[] = [];
    let confidence = 0;
    let direction: 'long' | 'short' | null = null;

    // ═══════════════════════════════════════════════════════════════
    // LONG SETUP: RSI oversold + BB lower touch
    // ═══════════════════════════════════════════════════════════════
    if (rsiSignal < 30 && signalBar.low <= bbSignal.lower) {
      direction = 'long';
      confidence += 30;
      triggers.push(`RSI oversold at ${rsiSignal.toFixed(1)}`);
      reasonCodes.push('RSI_OVERSOLD');
      triggers.push(`Price touched lower BB at ${bbSignal.lower.toFixed(5)}`);
      reasonCodes.push('BB_TOUCH_LOWER');

      if (rsiSignal < 20) {
        confidence += 10;
        triggers.push('RSI extremely oversold');
        reasonCodes.push('RSI_EXTREME_LOW');
      }

      if (signalBar.close > smaSignal) {
        confidence += 15;
        triggers.push('Price closed above SMA20');
        reasonCodes.push('TREND_ALIGNED');
      }

      if (signalBar.close > signalBar.open) {
        confidence += 10;
        triggers.push('Bullish candle confirmation');
        reasonCodes.push('CANDLE_CONFIRMATION');  // ✅ FIX 4: Added
      }
    } 
    // ═══════════════════════════════════════════════════════════════
    // SHORT SETUP: RSI overbought + BB upper touch
    // ═══════════════════════════════════════════════════════════════
    else if (rsiSignal > 70 && signalBar.high >= bbSignal.upper) {
      direction = 'short';
      confidence += 30;
      triggers.push(`RSI overbought at ${rsiSignal.toFixed(1)}`);
      reasonCodes.push('RSI_OVERBOUGHT');
      triggers.push(`Price touched upper BB at ${bbSignal.upper.toFixed(5)}`);
      reasonCodes.push('BB_TOUCH_UPPER');

      if (rsiSignal > 80) {
        confidence += 10;
        triggers.push('RSI extremely overbought');
        reasonCodes.push('RSI_EXTREME_HIGH');
      }

      if (signalBar.close < smaSignal) {
        confidence += 15;
        triggers.push('Price closed below SMA20');
        reasonCodes.push('TREND_ALIGNED');
      }

      if (signalBar.close < signalBar.open) {
        confidence += 10;
        triggers.push('Bearish candle confirmation');
        reasonCodes.push('CANDLE_CONFIRMATION');  // ✅ FIX 4: Added
      }
    }

    if (!direction) return null;

    // ═══════════════════════════════════════════════════════════════
    // TRADE CONSTRUCTION
    // ═══════════════════════════════════════════════════════════════
    const entryPrice = entryBar.open;
    const atrValue = atrSignal;

    const stopLossPrice =
      direction === 'long'
        ? entryPrice - atrValue * 1.5
        : entryPrice + atrValue * 1.5;

    const takeProfitPrice =
      direction === 'long'
        ? entryPrice + atrValue * 2
        : entryPrice - atrValue * 2;

    if (!validateOrder(direction, entryPrice, stopLossPrice, takeProfitPrice)) return null;

    const rr = Math.abs(takeProfitPrice - entryPrice) / Math.abs(entryPrice - stopLossPrice);

    // ✅ FIX 5: With TP=2ATR and SL=1.5ATR, RR is ~1.33, so threshold must be <= 1.33
    if (rr >= 1.25) {
      confidence += 10;
      reasonCodes.push('RR_FAVORABLE');
    }

    confidence = clamp(confidence, 0, 100);

    return buildDecision({
      symbol,
      strategyId: this.meta.id,
      strategyName: this.meta.name,
      direction,
      confidence,
      entryPrice,
      stopLoss: stopLossPrice,
      takeProfit: takeProfitPrice,
      triggers,
      reasonCodes,
      settings,
    });
  }
}

═══════════════════════════════════════════════════════════════════════════════
VERIFY ReasonCode TYPE:
═══════════════════════════════════════════════════════════════════════════════

Check src/strategies/types.ts - ensure these reason codes exist:
- RSI_OVERSOLD
- RSI_OVERBOUGHT
- RSI_EXTREME_LOW
- RSI_EXTREME_HIGH
- BB_TOUCH_LOWER
- BB_TOUCH_UPPER
- TREND_ALIGNED
- CANDLE_CONFIRMATION  ← May need to add this
- RR_FAVORABLE

If CANDLE_CONFIRMATION doesn't exist, either:
A) Add it to ReasonCode type, or
B) Use existing code like 'BULLISH_CONFIRMATION' / 'BEARISH_CONFIRMATION'

═══════════════════════════════════════════════════════════════════════════════
WHAT WAS NOT CHANGED (Intentional):
═══════════════════════════════════════════════════════════════════════════════

- Core logic: RSI < 30 + BB lower touch (LONG), RSI > 70 + BB upper touch (SHORT)
- Stop loss: 1.5 × ATR
- Take profit: 2.0 × ATR
- SMA20 as trend reference
- Bollinger Bands requirement
- No EMA200 trend filter (this is mean reversion, not trend-following)
- No ADX filter (optional enhancement for later)

This strategy remains a MEAN REVERSION strategy.
The new RsiOversold (with-trend pullback) will be a SEPARATE file.

═══════════════════════════════════════════════════════════════════════════════