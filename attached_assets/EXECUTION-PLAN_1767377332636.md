# CORRECTED EXECUTION PLAN
## forex-decision-engine V1 → V1.1

**Source:** Replit Senior Dev Analysis + Three-Way Audit
**Date:** January 2, 2026

---

## ⚠️ CRITICAL: DEPENDENCY ORDER

The MASTER-PATCH-FILE has an implicit dependency issue:
- **Patch 1** (server.ts) imports `checkDrawdownLimits` from `drawdownGuard.ts`
- **Patch 7** creates that file

**You MUST apply patches in this order, NOT the order in the document:**

```
P7 → P2 → P3 → P4 → P6 → P5 → P1 → ADDITIONAL FIXES → VERIFY
```

---

## PHASE 0: BACKUP

```bash
# Create timestamped backup
BACKUP_DIR="src_backup_$(date +%Y%m%d_%H%M%S)"
cp -r src/ "$BACKUP_DIR"
echo "Backup created: $BACKUP_DIR"
```

---

## PHASE 1: INFRASTRUCTURE (P7 + P2 + P3)

### Step 1.1: Create drawdownGuard.ts (P7) — DO THIS FIRST

**Action:** Create new file `src/services/drawdownGuard.ts`

Copy the entire content from MASTER-PATCH-FILE Section "PATCH 7: drawdownGuard.ts"

**Verify:**
```bash
# File exists and has content
wc -l src/services/drawdownGuard.ts
# Expected: ~280 lines

# Create data directory
mkdir -p ./data/drawdown
```

---

### Step 1.2: Update defaults.ts (P2)

**Action:** Modify `src/config/defaults.ts`

1. Find `CRYPTO_CONTRACT_SIZES` and replace with MT5-verified values
2. Change `getCryptoContractSize()` return type from `number` to `number | null`
3. Add `KNOWN_CRYPTO_SYMBOLS` export
4. Add `isKnownCryptoSymbol()` helper

**Verify:**
```bash
# Check new function signature
grep -A5 "getCryptoContractSize" src/config/defaults.ts
# Should show: ): number | null {
```

---

### Step 1.3: Update e8InstrumentSpecs.ts (P3)

**Action:** Modify `src/config/e8InstrumentSpecs.ts`

Replace entire `CRYPTO_SPECS` array with the corrected values from MASTER-PATCH-FILE.

**Verify:**
```bash
# Check BTCUSD contractSize
grep -A3 "BTCUSD" src/config/e8InstrumentSpecs.ts | grep contractSize
# Expected: contractSize: 2,

# Check XRPUSD contractSize
grep -A3 "XRPUSD" src/config/e8InstrumentSpecs.ts | grep contractSize
# Expected: contractSize: 100000,
```

---

## PHASE 2: VALIDATION HARDENING (P4 + P6)

### Step 2.1: Update utils.ts (P4)

**Action:** Modify `src/strategies/utils.ts`

1. Change `validateIndicators()` from warn+continue → hard-fail
2. Add `validatePositionSize()` function
3. Add `calculateCryptoPositionSize()` function
4. Add import: `import { getCryptoContractSize } from '../config/defaults.js';`

**Verify:**
```bash
# Check validateIndicators returns false on mismatch
grep -A3 "indicatorLength !== barsLength" src/strategies/utils.ts
# Should show: return false;
```

---

### Step 2.2: Update twelveDataClient.ts (P6)

**Action:** Modify `src/services/twelveDataClient.ts`

Global find/replace:
```
outputsize: '100'  →  outputsize: '300'
```

**Verify:**
```bash
# Count occurrences of outputsize
grep -c "outputsize: '300'" src/services/twelveDataClient.ts
# Should be 2+ occurrences

# Ensure no old values remain
grep "outputsize: '100'" src/services/twelveDataClient.ts
# Should return nothing
```

---

## PHASE 3: STRATEGY UPDATES (P5)

### Step 3.1: Update minBars in 5 Strategy Files

| File | Change |
|------|--------|
| `src/strategies/intraday/EmaPullback.ts` | `bars.length < 50` → `bars.length < 250` |
| `src/strategies/intraday/RsiOversold.ts` | H4 trend check to 250 bars |
| `src/strategies/intraday/CciZeroLine.ts` | `bars.length < 50` → `bars.length < 250` |
| `src/strategies/intraday/BollingerMR.ts` | `bars.length < 50` → `bars.length < 250` |
| `src/strategies/intraday/StochasticOversold.ts` | `bars.length < 50` → `bars.length < 250` |

**For each file, change both occurrences:**
```typescript
// Line 1: Early return check
if (!bars || bars.length < 250) return null;  // Was 50

// Line 2: validateIndicators call
if (!validateIndicators(..., 250)) return null;  // Was 50
```

**Verify:**
```bash
# Check EmaPullback
grep "bars.length < 250" src/strategies/intraday/EmaPullback.ts
# Should return 1 match
```

---

### Step 3.2: Add Missing meta.timeframes (6 Strategy Files)

Per earlier audit, these strategies are missing `timeframes` in their meta object:

| File | Add to meta object |
|------|-------------------|
| `StochasticOversold.ts` | `timeframes: { trend: 'H4', entry: 'H1' },` |
| `BollingerMR.ts` | `timeframes: { trend: 'H4', entry: 'H1' },` |
| `WilliamsEma.ts` | `timeframes: { trend: 'H4', entry: 'H1' },` |
| `CciZeroLine.ts` | `timeframes: { trend: 'H4', entry: 'H1' },` |
| `BreakRetest.ts` | `timeframes: { trend: 'H4', entry: 'H1' },` |
| `TripleEma.ts` | `timeframes: { trend: 'H4', entry: 'H1' },` |

**Example fix:**
```typescript
// In each strategy's meta object, add:
meta = {
  id: 'stochastic-oversold',
  name: 'Stochastic Oversold',
  // ... other fields ...
  timeframes: { trend: 'H4', entry: 'H1' },  // ← ADD THIS
  requiredIndicators: [...],
};
```

---

## PHASE 4: ROUTE LOCKDOWN (P1)

### Step 4.1: Update server.ts Imports

**Find these lines at the top:**
```typescript
import { analyzeSymbol, scanSymbols, UserSettings, Decision } from './engine/decisionEngine.js';
```

**Replace with:**
```typescript
// LEGACY ENGINE DISABLED (V1.1 - 2026-01-02)
// import { analyzeSymbol, scanSymbols } from './engine/decisionEngine.js';

import { scanWithStrategy } from './engine/strategyAnalyzer.js';
import { strategyRegistry } from './strategies/registry.js';
import { checkDrawdownLimits } from './services/drawdownGuard.js';
```

---

### Step 4.2: Replace /api/analyze Handler

Find the `/api/analyze` route and replace entirely with the 410 Gone response from MASTER-PATCH-FILE.

---

### Step 4.3: Replace /api/scan Handler

Find the `/api/scan` route and replace entirely with the new handler from MASTER-PATCH-FILE that includes:
- Gate 1: Require strategyId
- Gate 2: Validate symbols
- Gate 3: Mandatory drawdown check
- NO legacy fallback

---

### Step 4.4: Fix signalStore.ts Import (ADDITIONAL FIX)

**File:** `src/stores/signalStore.ts`

**Find:**
```typescript
import { Decision } from '../engine/decisionEngine.js';
```

**Replace with:**
```typescript
import { Decision } from '../strategies/types.js';
```

---

## PHASE 5: ADDITIONAL FIXES (From Replit Analysis)

These were identified by Replit but NOT in the MASTER-PATCH-FILE:

### Fix 5.1: Sentiment Display Bug

**File:** `public/app.js` (or wherever frontend is)
**Line:** ~551

**Find:**
```javascript
data.sentiment
```

**Replace with:**
```javascript
data.rating
```

---

### Fix 5.2: Remove Dead Code

**File:** `public/ui.js`
**Line:** ~195

**Find and DELETE:**
```javascript
// Any code checking decision.sentiment (field doesn't exist)
if (decision.sentiment) { ... }
```

---

### Fix 5.3: Add Entry Field to No-Trade Decisions

**File:** `src/engine/strategyAnalyzer.ts`
**Line:** ~416 (in createNoTradeDecision function)

**Add to the returned object:**
```typescript
entry: { price: 0, formatted: '—' },
```

**Context:**
```typescript
function createNoTradeDecision(symbol: string, reason: string): Decision {
  return {
    symbol,
    action: 'NO_TRADE',
    direction: null,
    confidence: 0,
    entry: { price: 0, formatted: '—' },  // ← ADD THIS LINE
    // ... rest of fields
  };
}
```

---

## PHASE 6: VERIFICATION

### Step 6.1: TypeScript Compilation

```bash
npm run typecheck
```

**Expected:** No errors

**Common issues:**
- Import path mismatches (check .js vs no extension)
- Missing type imports
- Return type mismatches (number vs number | null)

---

### Step 6.2: Start Server

```bash
npm run dev
```

**Watch for:**
- Import errors (files not found)
- Type errors at runtime
- Missing data directory errors

---

### Step 6.3: Endpoint Tests

```bash
# Test 1: Legacy route blocked (expect 410)
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/analyze \
  -H "Content-Type: application/json" \
  -d '{"symbol":"EURUSD"}'
# Expected: 410

# Test 2: strategyId required (expect 400)
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/scan \
  -H "Content-Type: application/json" \
  -d '{"symbols":["EURUSD"]}'
# Expected: 400

# Test 3: Equity required (expect 400)
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/scan \
  -H "Content-Type: application/json" \
  -d '{"symbols":["EURUSD"],"strategyId":"rsi-bounce","settings":{"accountSize":10000}}'
# Expected: 400

# Test 4: Paper trading bypasses equity check (expect 200)
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/scan \
  -H "Content-Type: application/json" \
  -d '{"symbols":["EURUSD"],"strategyId":"rsi-bounce","settings":{"paperTrading":true}}'
# Expected: 200

# Test 5: Full valid request (expect 200)
curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:5000/api/scan \
  -H "Content-Type: application/json" \
  -d '{"symbols":["EURUSD"],"strategyId":"rsi-bounce","settings":{"equity":10000,"accountSize":10000,"riskPercent":0.5}}'
# Expected: 200

# Test 6: State file created
ls -la ./data/drawdown/
# Expected: default.json exists after Test 5
```

---

### Step 6.4: Crypto Sizing Sanity Check

```bash
# Test unknown crypto blocked
curl -X POST http://localhost:5000/api/scan \
  -H "Content-Type: application/json" \
  -d '{"symbols":["DOGEUSDT"],"strategyId":"rsi-bounce","settings":{"equity":10000,"paperTrading":true}}'
# Expected: Position sizing should fail with "Unknown crypto symbol"
```

---

## EXECUTION CHECKLIST

```
□ Phase 0: Backup created
□ Phase 1.1: drawdownGuard.ts created
□ Phase 1.2: defaults.ts updated (fail-closed crypto)
□ Phase 1.3: e8InstrumentSpecs.ts synced
□ Phase 2.1: utils.ts updated (hard-fail alignment)
□ Phase 2.2: twelveDataClient.ts outputsize=300
□ Phase 3.1: 5 strategies minBars=250
□ Phase 3.2: 6 strategies meta.timeframes added
□ Phase 4.1: server.ts imports updated
□ Phase 4.2: /api/analyze returns 410
□ Phase 4.3: /api/scan requires strategyId + equity
□ Phase 4.4: signalStore.ts import fixed
□ Phase 5.1: sentiment → rating fix
□ Phase 5.2: Dead code removed
□ Phase 5.3: entry field added to no-trade
□ Phase 6.1: TypeScript compiles
□ Phase 6.2: Server starts
□ Phase 6.3: All 6 curl tests pass
□ Phase 6.4: Crypto sizing test passes
```

---

## ROLLBACK

If anything breaks:

```bash
# Restore from backup
rm -rf src/
cp -r src_backup_YYYYMMDD_HHMMSS/ src/
npm run dev
```

---

## POST-DEPLOYMENT

After successful deployment:

1. **Delete backup** (after 24h of stable operation)
2. **Continue MT5 screenshots** for remaining 38 symbols
3. **Update documentation** with new API requirements
4. **Notify any API consumers** about strategyId + equity requirements

---

*Execution plan corrected based on Replit Senior Dev Analysis*
*Dependency order fixed: P7 → P2 → P3 → P4 → P6 → P5 → P1*
*January 2, 2026*
