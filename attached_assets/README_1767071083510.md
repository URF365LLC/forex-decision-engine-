# P0 Critical Tasks - Implementation Patches

## Overview

This folder contains **3 P0 Critical patches** for the Forex Decision Engine. These must be implemented first as they block core functionality.

| Task | File | Issue | Impact |
|------|------|-------|--------|
| **#1** | `P0-TASK-1-indicatorService.patch.ts` | Missing indicator mappings | Blocks 5 of 8 strategies |
| **#2** | `P0-TASK-2-noTradeCaching.patch.ts` | No-trade decisions not cached | ~288 wasted API calls/scan |
| **#3** | `P0-TASK-3-cacheTTL.patch.ts` | Cache TTL not optimized | Stale H1/H4 data |

---

## Implementation Order

```
Task #1 → Task #3 → Task #2
```

**Why this order?**
1. Task #1 adds the indicators (required for strategies to work)
2. Task #3 sets up proper caching infrastructure
3. Task #2 uses the cache infrastructure from Task #3

---

## Task #1: Missing Indicator Mappings

### Files to Modify

1. **`src/types/strategy.ts`** - Update `StrategyIndicatorData` interface
2. **`src/services/alphaVantageClient.ts`** - Add 5 new API methods
3. **`src/engine/indicatorService.ts`** - Update `IndicatorData` interface and `fetchIndicators()`
4. **`src/engine/strategyAnalyzer.ts`** - Update `convertToStrategyIndicatorData()`

### New Indicators Required

| Indicator | Alpha Vantage Function | Strategy Using It |
|-----------|----------------------|-------------------|
| `stoch` | `STOCH` | Stochastic Momentum |
| `willr` | `WILLR` | Williams %R Reversal |
| `cci` | `CCI` | CCI Trend |
| `bbands` | `BBANDS` | Bollinger Breakout |
| `sma20` | `SMA` | Multi-Timeframe Alignment |

### Quick Implementation Steps

```typescript
// 1. Add to alphaVantageClient.ts (5 new methods):
async getSTOCH(symbol, interval, fastkperiod, slowkperiod, slowdperiod)
async getWILLR(symbol, interval, timePeriod)
async getCCI(symbol, interval, timePeriod)
async getBBANDS(symbol, interval, timePeriod, nbdevup, nbdevdn)
async getSMA(symbol, interval, timePeriod)

// 2. Add to IndicatorData interface:
stoch: { k: IndicatorValue[]; d: IndicatorValue[] };
willr: IndicatorValue[];
cci: IndicatorValue[];
bbands: { upper: IndicatorValue[]; middle: IndicatorValue[]; lower: IndicatorValue[] };
sma20: IndicatorValue[];

// 3. Add to fetchIndicators() - call the new API methods

// 4. Add to convertToStrategyIndicatorData():
stochK: getLatest(data.stoch?.k ?? []),
stochD: getLatest(data.stoch?.d ?? []),
// ... etc (see patch file for complete mapping)
```

---

## Task #2: Cache No-Trade Decisions

### Files to Modify

1. **`src/engine/strategyAnalyzer.ts`** - Add caching logic

### Key Changes

```typescript
// Constants
const NO_TRADE_CACHE_TTL_MS = 2 * 60 * 1000; // 2 minutes
const NO_TRADE_CACHE_PREFIX = 'no-trade:';

// Before analysis, check cache:
const cachedResult = getCachedNoTrade(symbol, strategyId, settings.style);
if (cachedResult.cached) {
  return cachedResult.decision;
}

// After analysis, cache no-trade results:
if (decision.grade === 'no-trade') {
  cacheNoTradeDecision(symbol, strategyId, settings.style, decision);
}
```

### Expected Savings

- **Before**: 36 symbols × 8 strategies × 12 scans = 3,456 API fetches
- **After**: First scan fetches, subsequent 2-min window uses cache
- **Savings**: ~50-70% reduction in API calls for stable markets

---

## Task #3: Cache TTL Optimization

### Files to Modify

1. **`src/services/cache.ts`** - Update TTL configuration and add helper methods
2. **`src/services/alphaVantageClient.ts`** - Update cache calls to use timeframe-aware methods

### New TTL Configuration

```typescript
const CACHE_TTL = {
  ohlcv: {
    '60min': 60 * 60 * 1000,     // H1 OHLCV: 60 min (candle duration)
    'daily': 4 * 60 * 60 * 1000, // Daily: 4 hours
  },
  indicators: {
    '60min': 5 * 60 * 1000,      // H1 indicators: 5 min ← CHANGED
    'daily': 4 * 60 * 60 * 1000, // Daily: 4 hours
  },
  aggregated: {
    'H4': 30 * 60 * 1000,        // H4 data: 30 min ← CHANGED
  },
};
```

### Migration Pattern

```typescript
// BEFORE (hardcoded):
cache.set(cacheKey, data, 60 * 60 * 1000);

// AFTER (timeframe-aware):
cache.setIndicator(cacheKey, data, interval);
// or
cache.setOHLCV(cacheKey, data, interval);
```

---

## Testing Checklist

### After Task #1
- [ ] `npm run build` compiles without errors
- [ ] STOCH endpoint returns data for EURUSD
- [ ] WILLR endpoint returns data for EURUSD
- [ ] CCI endpoint returns data for EURUSD
- [ ] BBANDS endpoint returns data for EURUSD
- [ ] SMA endpoint returns data for EURUSD
- [ ] All 5 blocked strategies now produce signals

### After Task #2
- [ ] First scan fetches fresh data
- [ ] Second scan within 2 min uses cache for no-trade symbols
- [ ] Logs show "Cache hit for no-trade: {symbol}" messages
- [ ] Force refresh bypasses cache

### After Task #3
- [ ] H1 indicators refresh every 5 minutes
- [ ] Daily indicators cache for 4 hours
- [ ] Cache stats show proper TTL distribution
- [ ] API rate limit not exceeded

---

## API Rate Limit Consideration

**Alpha Vantage Premium**: 150 calls/minute

### Current Usage Estimate (After All Tasks)
- Initial indicator fetch: ~10 calls per symbol
- 36 symbols = ~360 calls for full scan
- With 5-min cache: ~72 calls/hour for H1 indicators

### Recommendation
- Implement Task #3 cache optimization first
- Monitor API usage in logs
- Consider batching if hitting limits

---

## Quick Copy-Paste Snippets

### Add to `StrategyIndicatorData` interface:

```typescript
// Stochastic
stochK: number | null;
stochD: number | null;
stochKPrevious: number | null;
stochDPrevious: number | null;

// Williams %R
willr: number | null;
willrPrevious: number | null;

// CCI
cci: number | null;
cciPrevious: number | null;

// Bollinger Bands
bbandsUpper: number | null;
bbandsMiddle: number | null;
bbandsLower: number | null;
bbandsPreviousUpper: number | null;
bbandsPreviousLower: number | null;

// SMA
sma20: number | null;
```

### Add to `convertToStrategyIndicatorData()`:

```typescript
// Stochastic
stochK: getLatest(data.stoch?.k ?? []),
stochD: getLatest(data.stoch?.d ?? []),
stochKPrevious: getPrevious(data.stoch?.k ?? [], 1),
stochDPrevious: getPrevious(data.stoch?.d ?? [], 1),

// Williams %R
willr: getLatest(data.willr ?? []),
willrPrevious: getPrevious(data.willr ?? [], 1),

// CCI
cci: getLatest(data.cci ?? []),
cciPrevious: getPrevious(data.cci ?? [], 1),

// Bollinger Bands
bbandsUpper: getLatest(data.bbands?.upper ?? []),
bbandsMiddle: getLatest(data.bbands?.middle ?? []),
bbandsLower: getLatest(data.bbands?.lower ?? []),
bbandsPreviousUpper: getPrevious(data.bbands?.upper ?? [], 1),
bbandsPreviousLower: getPrevious(data.bbands?.lower ?? [], 1),

// SMA 20
sma20: getLatest(data.sma20 ?? []),
```

---

## Support

If Replit's AI assistant needs clarification on any patch, refer to the detailed comments in each `.patch.ts` file. Each file contains:

1. Problem description
2. Exact file locations
3. Complete code snippets
4. Implementation notes
5. Testing guidance
